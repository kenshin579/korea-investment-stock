# Phase 3.1: EGW00201 ì—ëŸ¬ ê°ì§€ ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì—…ì¼**: 2024-12-28  
**Issue**: #27 - Rate Limiting ê°œì„   
**Phase**: 3.1 - EGW00201 ì—ëŸ¬ ê°ì§€ ë¡œì§ ì¶”ê°€

## ğŸ“‹ êµ¬í˜„ ì‚¬í•­ ìš”ì•½

### 1. API ì‘ë‹µ ì½”ë“œ ì¶”ê°€ âœ…
```python
API_RETURN_CODE = {
    "SUCCESS": "0",  # ì¡°íšŒë˜ì—ˆìŠµë‹ˆë‹¤
    "EXPIRED_TOKEN": "1",  # ê¸°ê°„ì´ ë§Œë£Œëœ token ì…ë‹ˆë‹¤
    "NO_DATA": "7",  # ì¡°íšŒí•  ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤
    "RATE_LIMIT_EXCEEDED": "EGW00201",  # Rate limit ì´ˆê³¼
}
```

### 2. ìë™ ì¬ì‹œë„ ë°ì½”ë ˆì´í„° êµ¬í˜„ âœ…
```python
def retry_on_rate_limit(max_retries=5):
    """Rate limit ì—ëŸ¬ ì‹œ ìë™ ì¬ì‹œë„ ë°ì½”ë ˆì´í„°"""
```

**ì£¼ìš” ê¸°ëŠ¥**:
- EGW00201 ì—ëŸ¬ ê°ì§€ ì‹œ ìë™ ì¬ì‹œë„
- Exponential Backoff ì ìš© (`__handle_rate_limit_error` í˜¸ì¶œ)
- ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì‹œì—ë„ ì¬ì‹œë„
- ì—ëŸ¬ í†µê³„ ìë™ ê¸°ë¡ (`rate_limiter.record_error()`)
- ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ ì‹œ ì›ë³¸ ì—ëŸ¬ ë°˜í™˜

### 3. API ë©”ì„œë“œì— ë°ì½”ë ˆì´í„° ì ìš© âœ…
ë‹¤ìŒ ë©”ì„œë“œë“¤ì— `@retry_on_rate_limit()` ì ìš©:
- `issue_access_token` (max_retries=3)
- `fetch_etf_domestic_price`
- `fetch_domestic_price`
- `__fetch_price_detail_oversea`
- `__fetch_stock_info`
- `__fetch_search_stock_info`

### 4. í…ŒìŠ¤íŠ¸ êµ¬í˜„ âœ…
`test_rate_limit_error_detection.py` í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:

1. **Rate Limit ì—ëŸ¬ ê°ì§€ í…ŒìŠ¤íŠ¸**
   - ì •ìƒ ì‘ë‹µ ì²˜ë¦¬
   - Rate limit ì—ëŸ¬ í›„ ì¬ì‹œë„ ì„±ê³µ
   - ê³„ì†ë˜ëŠ” Rate limit ì—ëŸ¬ (ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼)

2. **ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì¬ì‹œë„ í…ŒìŠ¤íŠ¸**
   - ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ í›„ ì„±ê³µ
   - ê³„ì†ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬

3. **ì—ëŸ¬ í†µê³„ ê¸°ë¡ í…ŒìŠ¤íŠ¸**
   - `rate_limiter.record_error()` í˜¸ì¶œ í™•ì¸

## ğŸ” ë™ì‘ ë°©ì‹

### Rate Limit ì—ëŸ¬ ê°ì§€ íë¦„
```
API í˜¸ì¶œ â†’ ì‘ë‹µ ìˆ˜ì‹  â†’ rt_cd í™•ì¸
    â†“
rt_cd == "EGW00201"?
    â†“ Yes
ì—ëŸ¬ í†µê³„ ê¸°ë¡
    â†“
ì¬ì‹œë„ íšŸìˆ˜ < max_retries?
    â†“ Yes              â†“ No
Exponential Backoff   ì—ëŸ¬ ë°˜í™˜
    â†“
ì¬ì‹œë„
```

### Exponential Backoff ëŒ€ê¸° ì‹œê°„
- 1ì°¨ ì¬ì‹œë„: 1ì´ˆ + jitter (0~0.1ì´ˆ)
- 2ì°¨ ì¬ì‹œë„: 2ì´ˆ + jitter (0~0.2ì´ˆ)
- 3ì°¨ ì¬ì‹œë„: 4ì´ˆ + jitter (0~0.4ì´ˆ)
- 4ì°¨ ì¬ì‹œë„: 8ì´ˆ + jitter (0~0.8ì´ˆ)
- 5ì°¨ ì¬ì‹œë„: 16ì´ˆ + jitter (0~1.6ì´ˆ)
- ìµœëŒ€ ëŒ€ê¸°: 32ì´ˆ + jitter

## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ì„±ê³µ ì‚¬ë¡€
- âœ… ì •ìƒ ì‘ë‹µ ì‹œ ì¬ì‹œë„ ì—†ì´ ì¦‰ì‹œ ë°˜í™˜
- âœ… Rate limit ì—ëŸ¬ 2íšŒ í›„ 3ë²ˆì§¸ ì„±ê³µ ì‹œ ì •ìƒ ë°˜í™˜
- âœ… ìµœëŒ€ ì¬ì‹œë„ 5íšŒ ì´ˆê³¼ ì‹œ EGW00201 ë°˜í™˜
- âœ… ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì¬ì‹œë„ ì •ìƒ ì‘ë™

### íš¨ê³¼
1. **ìë™ ë³µêµ¬**: ì¼ì‹œì ì¸ rate limit ì´ˆê³¼ ì‹œ ìë™ ì¬ì‹œë„ë¡œ ë³µêµ¬
2. **ì„œë²„ ë³´í˜¸**: Exponential Backoffë¡œ ì„œë²„ ë¶€í•˜ ë°©ì§€
3. **í†µê³„ ìˆ˜ì§‘**: ì—ëŸ¬ ë°œìƒ ë¹ˆë„ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥
4. **ê°œë°œì í¸ì˜**: ë°ì½”ë ˆì´í„° ì ìš©ë§Œìœ¼ë¡œ ìë™ ì²˜ë¦¬

## ğŸ”„ ë‹¤ìŒ ë‹¨ê³„

Phase 3.2: Exponential Backoff êµ¬í˜„
- ì´ë¯¸ `__handle_rate_limit_error`ì— ê¸°ë³¸ êµ¬í˜„ ì™„ë£Œ
- ì¶”ê°€ ê°œì„  ì‚¬í•­ ê²€í†  í•„ìš”

## ğŸ“ ì£¼ìš” ë³€ê²½ íŒŒì¼
- `koreainvestmentstock.py`: ë°ì½”ë ˆì´í„° ë° API_RETURN_CODE ì¶”ê°€
- `test_rate_limit_error_detection.py`: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ êµ¬í˜„ 