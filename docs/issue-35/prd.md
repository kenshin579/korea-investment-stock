# Stress 테스트 PRD (계획 문서)

본 문서는 korea-investment-stock 라이브러리에 대해 “계획 단계”에서 스트레스 테스트(부하 테스트)를 어떻게 진행할지 정의한다. 본 문서는 구현/코드 변경 없이 테스트 목표, 시나리오, 방법론, 환경, 안전장치, 측정 지표, 보고 방식을 정리한다.

## 1. 목적과 배경
- 목적: 다수 종목/다수 엔드포인트에 대해 높은 호출량이 발생해도 라이브러리가 안정적으로 동작하는지 확인한다.
- 배경: 한국투자 API의 호출 제한이 초당 20건(1초당 20rps)이라는 전제하에서, 본 라이브러리가 내부적으로 적절히 스로틀링/재시도/큐잉을 통해 제한을 준수하는지 검증한다.
- 범위: “조회(Read) 계열 API” 중심으로 수행한다. 거래(Write)성 API는 본 스트레스 테스트 범위에 포함하지 않는다.

## 2. 성공 기준(Exit Criteria)
- 한국투자 API Rate Limit(초당 20rps)를 위반하지 않는다(429 혹은 유사 Rate Limit 에러가 통계적으로 0~극히 미미한 수준).
- 목표 트래픽(예: 10~18 rps 지속 부하, 30~40 rps 단기 버스트)을 걸어도 라이브러리 레벨에서 오류율(Error Rate) ≤ 0.5% 유지.
- p95 응답지연(latency) ≤ 1.5초, p99 ≤ 3초 내로 유지(네트워크/외부 API 변동성 감안, 값은 조정 가능).
- 테스트 러닝타임은 5분 이내로 제한한다(파일럿 단계). 장기 지속(30~60분) 검증은 별도 이슈에서 진행.

## 2.1. 주요 대상 메서드(korea-investment-stock)
- 본 스트레스 테스트의 1차 대상 메서드:
  - fetch_stock_info_list
  - fetch_search_stock_info_list
  - fetch_price_list

## 3. 제약 및 안전장치
- 하드 상한: 테스트 러너에서 글로벌 토큰 버킷(초당 18rps 내외)을 설정해 한국투자 API의 20rps를 밑도는 수준으로 제한.
- 재시도 정책: Rate Limit/일시적 네트워크 오류 발생 시 지수 백오프 + 지터(jitter 50~150ms) 적용. 최대 3회 재시도.
- 테스트 시간대: 실제 장중 과도한 부하를 피하기 위해 장외 시간 또는 사전 합의된 시간대 우선.
- 엔드포인트 종류: 계정·거래성 API는 호출하지 않는다. 시세/종목정보 등 조회성 API만 대상으로 한다.

## 4. 테스트 시나리오
- S1. 단일 종목 고빈도 조회
  - 한 종목(Ticker 1~3개)에 대해 짧은 주기로 연속 호출.
  - 목적: 캐시/레이트리미터 동작 및 단일 키 집중 부하에서의 안정성 확인.
- S2. 전 종목 라운드로빈 조회
  - config.yaml의 stock_list(국내/미국/ETF)에 등록된 모든 종목을 동일 주기로 라운드로빈 조회.
  - 목적: 전체 종목 사용 시 처리 지연/큐 적체/스루풋 한계와 레이트리미터/캐시 동작을 확인.
- S3. 버스트 + 안정 구간 혼합
  - 30초 버스트(목표 25~35 rps) 후 3분 안정(10~15 rps) 반복.
  - 목적: 단기 급증/회복 패턴에서 레이트리미팅, 백오프, 큐 배출 정상 여부 검증.
- S4. 캐시 히트/미스 비교
  - 동일 파라미터 반복 조회(캐시 히트 극대화) vs 파라미터 변조(캐시 미스 유도) 케이스 비교.
  - 목적: 캐시가 실제로 외부 API 호출을 줄이고 지연을 낮추는지 확인.
- S5. 에러/타임아웃 강건성
  - 의도적 타임아웃 단축(테스트 러너 측) 또는 네트워크 장애 주입(가능 시)으로 에러 처리/재시도 동작 확인.

## 5. 트래픽 모델(부하 프로파일)
- 램프업: 30~60초에 걸쳐 선형 증가(0 → 목표 rps).
- 유지(Duration): 5분(파일럿 단계 표준 러닝타임).
- 램프다운: 30~60초 선형 감소.
- 동시성(virtual users 혹은 worker 수): rps와 RTT에 따라 계산(대략 동시성 ≈ RPS × 평균RTT).
- 페이싱: 고정 주기 + ±10% 지터를 기본으로 하여 패턴화된 동시 요청 피크를 완화.

## 6. 메트릭 수집 및 관찰성
- 핵심 지표
  - 요청 수, 성공/실패 수, 오류율
  - 응답시간 p50/p90/p95/p99
  - 외부 API 429/5xx 비율, 재시도 횟수 분포
  - 내부 큐 길이/대기시간(가능 시), 캐시 히트율
  - 시스템 리소스(CPU, 메모리) 추이(테스트 머신 기준)
- 시각화/리포트
  - 저장 위치: 저장소 루트의 stress/ 폴더에 작업 산출물 및 결과를 저장한다.
  - 저장 형식: CSV/NDJSON 형태 원시 로그 + 집계 리포트(HTML/MD).
  - 기존 저장물 예시: 저장소 루트의 각종 모니터링 리포트 HTML 활용 계획 수립(api_monitoring_*.html 등). 실제 연결은 추후 구현 단계에서.

## 7. 환경 및 전제
- 환경
  - 로컬 개발 머신 혹은 별도 테스트 VM 1대(네트워크 안정성 필요).
  - 동일 환경에서 반복 테스트하여 비교 가능성 확보.
- 인증/키 관리
  - 실제 키는 테스트 러너의 환경변수로 주입. 문서/리포지토리에는 기록하지 않음.
- 시간대/시장 상태
  - 장중/장외 모두 테스트하여 응답 특성 차이 관찰(가능 시).

## 8. config.yaml 사용 계획
- 위치: docs/issue-35/config.yaml
- 역할: 테스트 대상 종목 목록과 테스트 파라미터(부하 프로파일, 레이트 제한, 지속시간 등)를 선언적으로 관리.
- 기본 구조(요약)
  - stock_list: [티커, 시장] 배열 목록(국내 KR/미국 US/ETF 포함)
  - load_profile: 목표 rps, 지속시간, 램프업/다운, 동시성 힌트
  - rate_limit_guard: 글로벌 상한(rps), 버스트 크기, 재시도 지터
  - scenario: 실행할 시나리오(S1~S5) 선택 및 각 시나리오별 세부 설정
  - reporting: 결과 저장 경로/형식

세부 스키마 예시는 본 문서 하단과 config.yaml 주석을 참고한다.

## 9. 실행 흐름(개념적, 비구현)
1) 테스트 러너 기동 → config.yaml 로딩 → 종목 집합과 파라미터 로딩
2) 글로벌 토큰 버킷/슬라이딩 윈도우로 rps 상한 적용(예: 18 rps)
3) 시나리오에 따라 요청 생성(라운드로빈/버스트 등) + 지터 부여
4) 요청 전송 전 캐시 가능 조건이면 캐시 조회(라이브러리 내부 동작 가정)
5) 응답 수집, 메트릭 기록, 에러 시 재시도(백오프+지터)
6) 테스트 종료 후 리포트 생성(지표/그래프)

## 10. 리스크 및 완화
- 과도한 외부 API 호출로 계정 제한 위험 → rps 하향(<=18), 버스트 최소화, 장외 수행, 감시 지표로 429 상승 시 즉시 중단.
- 데이터 왜곡(장중 이벤트 영향) → 반복/다중 시간대 수행으로 평균화.
- 불완전한 관찰성 → 로깅 스키마 표준화, 필수 지표 우선 수집.

## 11. 일정(초안)
- D0~D1: 문서 합의(본 문서) 및 config 스키마 확정
- D2: 테스트 러너 스캐폴드 작성(코드 변경은 별 이슈로)
- D3: 시나리오별 시범 실행(소량 rps) 및 메트릭 검증
- D4: 본 테스트 실행 및 리포트 공유

## 12. 오픈 이슈/결정 필요
- 목표 rps/버스트 구체값 확정(예시값: 지속 12~15 rps, 버스트 30 rps)
- 주요 대상 엔드포인트 목록 확정(시세/종목/호가 등 어떤 조회 API 포함할지)
- 테스트 시간대(장중/장외) 및 총 소요시간 합의

---

### [부록 A] config.yaml 스키마 예시(요약)
```yaml
# 필수: 테스트 대상 종목 목록
stock_list:
  - ["005930", "KR"]
  - ["AAPL", "US"]

# 선택: 부하 프로파일(값이 없으면 기본값 사용)
load_profile:
  target_rps: 15          # 지속 목표 rps
  ramp_up_sec: 30         # 램프업 시간(초)
  sustain_sec: 240        # 유지 시간(초)
  ramp_down_sec: 30       # 램프다운(초)
  max_concurrency: 200    # 동시 작업 상한(힌트)

# 선택: 레이트 제한 가드(외부 API 20rps 대비 보수적 설정)
rate_limit_guard:
  global_rps_cap: 18      # 절대 상한 rps(버퍼 포함)
  burst_size: 5           # 짧은 버스트 허용치(토큰 추가 허용)
  retry:
    max_attempts: 3
    backoff: exponential  # 고정, 선형, 지수 등
    base_delay_ms: 100
    jitter_ms: [50, 150]  # 지터 범위

# 선택: 실행 시나리오
scenario:
  enable:
    - S1   # 단일 종목 고빈도
    - S2   # 다종목 선형 스케일
    - S3   # 버스트 혼합
    - S4   # 캐시 히트/미스 비교
  s1:
    tickers:  ["005930:KR", "AAPL:US"]
    duration_sec: 300
  s2:
    use_all: true
    duration_sec: 300
  s3:
    burst_rps: 30
    burst_sec: 30
    cool_rps: 12
    cool_sec: 180
    cycles: 5
  s4:
    cache_hit_ratio_target: 0.8

# 선택: 리포팅
reporting:
  out_dir: ./stress
  formats: [csv, html]
```

본 문서는 계획 단계 문서이므로, 이 문서에 따라 실제 테스트 러너/코드 변경은 별도 이슈에서 진행한다. 현 단계에서는 config.yaml과 본 PRD 문서만 관리한다.
